---
title: cloudflare优选IP
date: 2024-10-03 21:53:22+08:00
lastMod: 2024-10-03 23:05:42+08:00
category: cloudflare
tags: []
sticky: 0
---

这篇文章补全[cloudflare tunnel优选IP | butlanys的博客 (hqycloud.top)](https://blog.hqycloud.top/posts/204d8c5f/)教程中未详细讲述cloudflare优选IP的内容

> 注意：开通此服务需要准备一张信用卡（貌似黑卡也能过？）

> 需准备两个域名，两个域名需分别托管到cloudflare和支持地域解析的服务商，这里推荐[共建智能世界云底座-华为云 (huaweicloud.com)](https://www.huaweicloud.com/) 因为他的tll值可以设置的非常小

# cloudflare面板

> 将回退域托管到cloudflare上

此域名只需要可托管到cloudflare即可，并不需要再花大价钱购买域名，这里推荐1刀一年的数字xyz

### 添加域名

点击添加域——输入或注册域名——点击继续

跟着配置向导走，最后会要求将nameserver修改为cloudflare提供的两条ns记录

在你的注册域名的服务商修改ns记录，例如：

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_c6b2ac0573d7ff49683d9da2d0df0329.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_c6b2ac0573d7ff49683d9da2d0df0329.png)

添加好以后回到cloudflare，点击立刻检查名称服务器即可，cloudflare检测后会给邮箱发一封邮件

### 添加一条指向源站的记录

进入域名后在左侧面板进入DNS——记录

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_b36f1edfb155bce89ee43e720d486463.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_b36f1edfb155bce89ee43e720d486463.png)

添加一条指向源站的dns记录

例如：

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_719d6a0f9e37aebda98a80b27b44bdde.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_719d6a0f9e37aebda98a80b27b44bdde.png)

这里的<代理状态>需要打开

### 开通cloudflare for saas

添加好后点域名，在左侧面板中按下图进入saas

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_924038f0a2a933cfb518b1c10423fb9a.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_924038f0a2a933cfb518b1c10423fb9a.png)

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_cf2773496abda9a87c68c9e53cd81320.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_cf2773496abda9a87c68c9e53cd81320.png)

点击启用cloudflare for saas

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_64a0071114296bada6fe3a7865ec80c7.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_64a0071114296bada6fe3a7865ec80c7.png)

这里会要求填写信用卡信息，如果你的卡段和环境足够干净，可以免验卡，或者也可以直接绑定PayPal

点击确认后，返回刚才的页面

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_df762f40b7ec2fd5ad768f48d256f4d2.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_df762f40b7ec2fd5ad768f48d256f4d2.png)

添加一个回退源

这里需要填刚才那条指向源站的域名（完整）

### 添加域名

点击添加自定义主机名

填写需要优选的域名，例如：

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_272f521a6650a555af1cceaea710d6a1.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_272f521a6650a555af1cceaea710d6a1.png)

点击添加自定义主机名

# cname接入cloudflare

### 接入支持地域解析的服务商

> 这里以华为云为例

打开华为云[共建智能世界云底座-华为云 (huaweicloud.com)](https://www.huaweicloud.com/) 登陆后点右上角控制台——左上角更多搜索域名，选择*域名解析服务* ——选择公网域名——创建公网域名

创建好域名后在购买域名的服务商添加华为云的ns记录

> ns1.huaweicloud-dns.org
>
> ns1.huaweicloud-dns.net
>
> ns1.huaweicloud-dns.cn
>
> ns1.huaweicloud-dns.com

### 添加需要优选的域名

添加完成后点管理解析——添加记录集

这里需要先cname到你刚才填写的回退源，例如：

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_1aeb98fc69978715c025358a17b5a88f.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_1aeb98fc69978715c025358a17b5a88f.png)

### 添加证书验证的记录

这里推荐使用cloudflare的**自定义主机名的 DCV 委派** ，因为只需添加一次，后面的证书颁发将会自动验证

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_f69f0af222cabeed1e9f57bc0885cd3e.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_f69f0af222cabeed1e9f57bc0885cd3e.png)

华为云添加：

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_d47ce5ed4d396788fb8a6700b52f0956.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_d47ce5ed4d396788fb8a6700b52f0956.png)

然后等待cloudflare那边生效

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_b0576e0a8ffcbb9d7aa4b7a84cd945dc.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_b0576e0a8ffcbb9d7aa4b7a84cd945dc.png)

生效后，就可以自定义cloudflare的cdn ip了

华为云解析管理中添加一个cname地域解析，选择中国大陆，记录填优选IP或优选域名，别人定时更新的优选域名都行

当然，如果你想自己也搞个优选域名，这里推荐[netcccyun/dnsmgr: 彩虹聚合DNS管理系统 (github.com)](https://github.com/netcccyun/dnsmgr)

随便找个虚拟主机或自己部署完之后，添加华为云服务商，接着添加一个域名

在左侧CF优选IP中添加一个子域

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_7656a5a28353bd3d656f0bb82af34ab0.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_7656a5a28353bd3d656f0bb82af34ab0.png)

配置好后提交，然后手动更新一遍，再将华为云中的域名cname解析到这条优选域上

# 最后！！！

然后就是喜闻乐见的全国绿（

![https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_bd2c40a89b5cde3778ccedb59ef4139e.png](https://github.hqycloud.top/https://raw.githubusercontent.com/hqycloud/blog-images/main/hexo-images/24/10/image_bd2c40a89b5cde3778ccedb59ef4139e.png)
