---
title: 解决自建不算子接入butterfly后一直转圈的问题
date: 2025-02-09 00:46:39+08:00
lastMod: 2025-02-09 01:00:31+08:00
summary: 这篇文章介绍了如何修改Busuanzi网站访问统计计数器的JavaScript代码，以适应其API的更新。  原代码中 `busuanzi_page_pv` 变量已更改为 `busuanzi_value_page_pv`，文章提供了修正后的JavaScript代码片段。该代码通过XMLHttpRequest向指定的API（可自定义）发送POST请求，获取网站访问量（PV、UV等）数据，并将其显示在页面上。代码包含了错误处理、数据格式化（支持逗号分隔、简写格式）和PJAX支持，使其能够在页面动态更新时正确显示计数器。  文章特别强调需要将代码中的API地址替换为用户自己的API地址，并建议用户理解代码逻辑后进行修改和使用。
tags: []
sticky: 0
---

> 原文：https://blog.liushen.fun/posts/e401be2d/

因为新版变量由原来busuanzi\_page\_pv → busuanzi\_value\_page\_pv故js需要修改

api后端请改为自己的

```javascript
! function() {
    let t = ["site_pv", "site_uv", "page_pv", "page_uv"],
        e = document.currentScript,
        a = e.hasAttribute("pjax"),
        n = e.getAttribute("data-api") || "https://busuanzi.butlanys.de/api",
        i = e.getAttribute("data-prefix") || "busuanzi",
        r = e.getAttribute("data-style") || "default",
        o = "bsz-id",
        s = () => {
            let e = new XMLHttpRequest;
            e.open("POST", n, !0);
            let a = localStorage.getItem(o);
            null != a && e.setRequestHeader("Authorization", "Bearer " + a), e.setRequestHeader("x-bsz-referer", window.location.href), e.onreadystatechange = function() {
                if (4 === e.readyState && 200 === e.status) {
                    let a = JSON.parse(e.responseText);
                    if (!0 === a.success) {
                        t.map((t => {
                            let elem = document.getElementById(`${i}_value_${t}`);
                            if (elem) {
                                elem.innerHTML = formatValue(a.data[t], r)
                            }
                            let n = document.getElementById(`${i}_container_${t}`);
                            if (n) {
                                n.style.display = "inline"
                            }
                        }));
                        let n = e.getResponseHeader("Set-Bsz-Identity");
                        null != n && "" != n && localStorage.setItem(o, n)
                    }
                }
            }, e.send()
        };

    function formatValue(t, e = "default") {
        if ("comma" === e) return t.toLocaleString();
        if ("short" === e) {
            const e = ["", "K", "M", "B", "T"];
            let a = Math.floor(Math.log10(t) / 3);
            return t /= Math.pow(1e3, a), `${Math.round(100*t)/100}${e[a]}`
        }
        return t.toString()
    }
    if (s(), a) {
        let t = window.history.pushState;
        window.history.pushState = function() {
            t.apply(this, arguments), s()
        }, window.addEventListener("popstate", (function(t) {
            s()
        }), !1)
    }
}();
```
